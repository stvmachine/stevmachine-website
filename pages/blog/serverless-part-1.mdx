---
title: "Starting with Serverless- Part 1"
publishedAt: "2021-01-13"
summary: "Installation and a start a new project"
tags:
  - serverless
  - cloud
---

## Table of Contents

- [Pre-requisites](#pre-requisites)
- [Step 1](#step-1-lets-create-a-nodejs-serverless-project)
- [Step 2](#step-2-create-a-rest-resource)
- [Step 3](#step-3-saving-data-to-dynamodb)
- [Step 4](#step-4-list-all-the-users)
- [Step 5](#step-5-get-user-details-by-id)
- [Resources](#resources)

## Pre-requisites

1. Install serverless

```bash
npm install serverless -g
```

2. Configure your [AWS credentials](https://www.serverless.com/framework/docs/providers/aws/guide/credentials/).

## Step 1: Let's create a Node.js serverless project

We want to create a simple service that allows us to upload user information.

Let's start creating the project.

```
$ serverless create --template aws-nodejs --path user-service --name user
```

This will create the directory `user-service` with the following structure:

```
.
├── .npmignore
├── handler.js
└── serverless.yml
```

Let's look at each of these three files one by one.

- `.npmignore`: This file is used to tell npm which files should be kept outside of the package.
- `handler.js`: This declares your Lambda function. The created Lambda function returns a body with `Go Serverless v1.0! Your function executed successfully!` message.
- `serverless.yml`: This file declares configuration that Serverless Framework uses to create your service. serverless.yml file has three sections — provider, functions, and resources.
  - provider: This section declares configuration specific to a cloud provider. You can use it to specify name of the cloud provider, region, runtime etc.
  - functions: This section is used to specify all the functions that your service is composed off. A service can be composed of one or more functions.
  - resources: This section declares all the resources that your functions use. Resources are declared using AWS CloudFormation.

## Step 2: Create a REST resource

Let's update the `serverless.yml` to handle POST to `/users`:

```yml
service: user-service

frameworkVersion: "2"

provider:
  name: aws
  runtime: nodejs12.x

functions:
  candidateSubmission:
    handler: api/user.submit
    memorySize: 128
    description: Submit user information and starts interview process.
    events:
      - http:
          path: users
          method: post
```

Then, we refactor a bit the file structure and we rename `handler.js` to `api/user.js`. Inside of this file, we define our functions, in this case `user.submit`:

```js
"use strict";

module.exports.submit = (event, context, callback) => {
  const response = {
    statusCode: 200,
    body: JSON.stringify({
      message: "Go Serverless v1.0! Your function executed successfully!",
      input: event,
    }),
  };

  callback(null, response);
};
```

We are ready to deploy:

```
sls deploy
```

```
Serverless: Packaging service...
Serverless: Excluding development dependencies...
Serverless: Creating Stack...
Serverless: Checking Stack create progress...
........
Serverless: Stack create finished...
Serverless: Ensuring that deployment bucket exists
Serverless: Uploading CloudFormation file to S3...
Serverless: Uploading artifacts...
Serverless: Uploading service user.zip file to S3 (587 B)...
Serverless: Validating template...
Serverless: Updating Stack...
Serverless: Checking Stack update progress...
..............................
Serverless: Stack update finished...
Service Information
service: user
stage: dev
region: us-east-1
stack: user-dev
resources: 11
api keys:
  None
endpoints:
  POST - https://3hlhmtm7cf.execute-api.us-east-1.amazonaws.com/dev/users
functions:
  candidateSubmission: user-dev-candidateSubmission
layers:
  None
```

Now, POST operation of your service is available. You can use tools like cURL to make a POST request.

```bash
$curl -X POST https://3hlhmtm7cf.execute-api.us-east-1.amazonaws.com/dev/users

{"message":"Go Serverless v1.0! Your function executed successfully!", "input":{...}}
```

## Step 3: Saving data to DynamoDB

We are going to add two tables: `user` and `candidate_email` to DynamoDB. To do that we need to update `serverless.yml` adding the section _environment_ and _iamRoleStatements_.

```yml
provider:
  name: aws
  runtime: nodejs12.x
  environment:
    USER_TABLE: ${self:service}-${opt:stage, self:provider.stage}
    USER_EMAIL_TABLE: "user-email-${opt:stage, self:provider.stage}"
  iamRoleStatements:
    - Effect: Allow
      Action:
        - dynamodb:Query
        - dynamodb:Scan
        - dynamodb:GetItem
        - dynamodb:PutItem
      Resource: "*"
```

Next, we'll create a resource that will create DynamoDB table as shown below.

```yml
resources:
  Resources:
    UsersDynamoDbTable:
      Type: "AWS::DynamoDB::Table"
      DeletionPolicy: Retain
      Properties:
        AttributeDefinitions:
          - AttributeName: "id"
            AttributeType: "S"
        KeySchema:
          - AttributeName: "id"
            KeyType: "HASH"
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        StreamSpecification:
          StreamViewType: "NEW_AND_OLD_IMAGES"
        TableName: ${self:provider.environment.USER_TABLE}
```

Now, you can deploy the function as shown below.

```bash
serverless deploy --verbose
```

And we can create a new user running:

```bash
curl -H "Content-Type: application/json" -X POST -d '{"fullname":"Esteban Campos","email": "campos.esteban@gmail.com", "experience":6}'

https://il2r2hckl5.execute-api.us-east-1.amazonaws.com/dev/users
```

## Step 4: List all the users

Let's add a new function to our `serverless.yml`.

```yaml
listUsers:
  handler: api/user.list
  memorySize: 128
  description: List all users
  events:
    - http:
        path: users
        method: get
```

We also need to add the implementation in the API:

```js
module.exports.list = (event, context, callback) => {
  var params = {
    TableName: process.env.USER_TABLE,
    ProjectionExpression: "id, fullname, email",
  };

  console.log("Scanning User table.");
  const onScan = (err, data) => {
    if (err) {
      console.log(
        "Scan failed to load data. Error JSON:",
        JSON.stringify(err, null, 2)
      );
      callback(err);
    } else {
      console.log("Scan succeeded.");
      return callback(null, {
        statusCode: 200,
        body: JSON.stringify({
          users: data.Items,
        }),
      });
    }
  };

  dynamoDb.scan(params, onScan);
};
```

And then we are able to use the function using cURL:

```bash
$curl -H "Content-Type: application/json" -X GET https://il2r2hckl5.execute-api.us-east-1.amazonaws.com/dev/users

{"users":[{"email":"campos.esteban@gmail.com","id":"c21c4c80-7299-11ec-86f3-234be33cf5b5","fullname":"Esteban Campos"}
```

## Step 5: Get User Details by ID

Define a new function in serverless.yml as shown below.

```yaml
candidateDetails:
  handler: api/user.get
  events:
    - http:
        path: users/{id}
        method: get
```

Define a new function in api/user.js

```js
module.exports.get = (event, context, callback) => {
  const params = {
    TableName: process.env.USER_TABLE,
    Key: {
      id: event.pathParameters.id,
    },
  };

  dynamoDb
    .get(params)
    .promise()
    .then((result) => {
      const response = {
        statusCode: 200,
        body: JSON.stringify(result.Item),
      };
      callback(null, response);
    })
    .catch((error) => {
      console.error(error);
      callback(new Error("Couldn't fetch user."));
      return;
    });
};
```

And we can test the function as well:

```bash
$curl -H "Content-Type: application/json" -X GET   https://il2r2hckl5.execute-api.us-east-1.amazonaws.com/dev/users/c21c4c80-7299-11ec-86f3-234be33cf5b5

{"experience":6,"updatedAt":1641876525384,"id":"c21c4c80-7299-11ec-86f3-234be33cf5b5","email":"campos.esteban@gmail.com","fullname":"Esteban Campos","submittedAt":1641876525384}
```

## Resources

- [Serverless Framework Documentation](https://www.serverless.com/framework/docs)
- [Building a REST API in Node.js with AWS Lambda, API Gateway, DynamoDB, and Serverless Framework](https://www.serverless.com/blog/node-rest-api-with-serverless-lambda-and-dynamodb)
- [Serverless DynamoDB Local](https://www.serverless.com/plugins/serverless-dynamodb-local)
